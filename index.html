<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TVBOX接口加密解密工具 - AES-128-CBC</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    .inner {
      display: flex;
      gap: 20px;
    }
    .textarea-group {
      flex: 1;
    }
    textarea {
      width: 100%;
      height: 500px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: none;
      font-family: monospace;
    }
    .input-group {
      width: 250px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #409eff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #66b1ff;
    }
    button.success {
      background-color: #67c23a;
    }
    button.success:hover {
      background-color: #85ce61;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h2>TVBOX接口加密解密工具 - AES-128-CBC</h2>
    <div class="inner">
      <div class="textarea-group">
        <textarea id="inputText" placeholder="请输入要加密/解密的文本内容..."></textarea>
      </div>
      <div class="input-group">
        <select id="actionType">
          <option value="encrypt">加密</option>
          <option value="decrypt">解密</option>
        </select>
        <input type="text" id="keyInput" placeholder="KEY/密码" maxlength="16" value="123456">
        <input type="text" id="ivInput" placeholder="IV/向量" maxlength="13" value="">
        <div class="checkbox-group">
          <input type="checkbox" id="base64Check">
          <label for="base64Check">Base64解码</label>
        </div>
        <div class="btn-group">
          <button id="uploadBtn">上传文件</button>
          <input type="file" id="fileInput" class="hidden">
          <button id="processBtn">执行</button>
          <button id="downloadBtn" class="success">加密下载</button>
        </div>
        <div class="iframe-group">
          <button id="toImageBtn">配置转图片</button>
          <input type="file" id="imageInput" class="hidden" accept=".txt,.json">
        </div>
      </div>
      <div class="textarea-group">
        <textarea id="outputText" placeholder="结果将显示在这里..." readonly></textarea>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化IV值为当前时间戳
      document.getElementById('ivInput').value = new Date().getTime();
      
      // 上传文件按钮点击事件
      document.getElementById('uploadBtn').addEventListener('click', function() {
        document.getElementById('fileInput').click();
      });
      
      // 文件选择事件
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('inputText').value = e.target.result;
        };
        reader.readAsText(file);
      });
      
      // 配置转图片按钮点击事件
      document.getElementById('toImageBtn').addEventListener('click', function() {
        document.getElementById('imageInput').click();
      });
      
      // 图片转换处理
      document.getElementById('imageInput').addEventListener('change', toImg);
      
      // 执行按钮点击事件
      document.getElementById('processBtn').addEventListener('click', processData);
      
      // 下载按钮点击事件
      document.getElementById('downloadBtn').addEventListener('click', downloadResult);
    });
    
    function padTo16Byte(str) {
      return CryptoJS.enc.Utf8.parse(str.toString().padEnd(16, '0'));
    }
    
    /**
     * AES加密:word加密字符串，以及字符串key、iv  返回Hex
     */
    function Encrypt(word, keyStr, ivStr) {
      const key = padTo16Byte(keyStr);
      const iv = padTo16Byte(ivStr);
      const encrypted = CryptoJS.AES.encrypt(word, key, {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });
      return encrypted.ciphertext.toString(CryptoJS.enc.Hex);
    }
    
    /**
     * 解密:字符串 key iv  返回Utf8
     */
    function Decrypt(word, keyStr, ivStr) {
      const key = padTo16Byte(keyStr);
      const iv = padTo16Byte(ivStr);
      const ciphertext = CryptoJS.enc.Hex.parse(word);
      const decrypt = CryptoJS.AES.decrypt({
        ciphertext: ciphertext
      }, key, {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      });
      return decrypt.toString(CryptoJS.enc.Utf8);
    }
    
    function decryptAesBCB(encryptedData) {
      var dataArr = encryptedData.split("");
      var prefixCode = CryptoJS.enc.Utf8.parse("$#").toString();
      var suffixCode = CryptoJS.enc.Utf8.parse("#$").toString();
      var pwdMix = dataArr
        .splice(0, encryptedData.indexOf(suffixCode) + 4)
        .join("");
      var roundtimeInHax = dataArr.splice(dataArr.length - 26, 26).join("");
      var encryptedText = dataArr.join("");
      var pwdInHax = pwdMix.substring(
        prefixCode.length,
        pwdMix.length - suffixCode.length
      );
      var roundTime = CryptoJS.enc.Utf8.stringify(
        CryptoJS.enc.Hex.parse(roundtimeInHax)
      );
      var pwd = CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Hex.parse(pwdInHax));
      var iv = CryptoJS.enc.Utf8.parse(roundTime.padEnd(16, "0"));
      var pkBlocks = CryptoJS.enc.Utf8.parse(pwd.padEnd(16, "0"));
      var cipherParams = CryptoJS.lib.CipherParams.create({
        ciphertext: CryptoJS.enc.Hex.parse(encryptedText),
      });
      var decryptedData = CryptoJS.enc.Utf8.stringify(
        CryptoJS.AES.decrypt(cipherParams, pkBlocks, {
          iv: iv,
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7,
        })
      );
      return decryptedData;
    }
    
    // 字符串转Hex
    function convertToHex(value) {
      return CryptoJS.enc.Hex.stringify(CryptoJS.enc.Utf8.parse(value));
    }
    
    // Hex转字符串
    function convertToString(value) {
      return CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Hex.parse(value));
    }
    
    function processData() {
      const inputText = document.getElementById('inputText').value;
      const actionType = document.getElementById('actionType').value;
      const key = document.getElementById('keyInput').value;
      const iv = document.getElementById('ivInput').value;
      const base64Check = document.getElementById('base64Check').checked;
      
      if (!inputText) {
        alert('请输入要处理的文本内容！');
        return;
      }
      
      try {
        let result;
        if (actionType === 'encrypt') {
          const resultData = Encrypt(inputText, key, iv);
          const keyHex = convertToHex(`$#${key}#$`);
          const ivHex = convertToHex(iv);
          result = `${keyHex}${resultData}${ivHex}`;
        } else {
          let encryptedData = inputText;
          if (base64Check) {
            encryptedData = window.atob(encryptedData.split("**")[1] || encryptedData);
          }
          result = decryptAesBCB(encryptedData);
        }
        
        document.getElementById('outputText').value = result;
      } catch (err) {
        console.error(err);
        alert('处理失败：' + err.message);
      }
    }
    
    function downloadResult() {
      const result = document.getElementById('outputText').value;
      if (!result) {
        alert('没有可下载的内容！');
        return;
      }
      
      const blob = new Blob([result], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'tvbox_config.txt';
      link.click();
      URL.revokeObjectURL(url);
    }
    
    function toImg(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置画布大小
        canvas.width = 800;
        canvas.height = Math.max(600, content.split('\n').length * 20 + 100);
        
        // 绘制背景
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 绘制标题
        ctx.fillStyle = 'black';
        ctx.font = 'bold 24px Arial';
        ctx.fillText('TVBOX配置', 50, 40);
        
        // 绘制文本内容
        ctx.font = '16px Arial';
        wrapText(ctx, content, 50, 80, canvas.width - 100, 20);
        
        // 转换为图片并下载
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = 'tvbox_config.png';
        link.click();
      };
      
      reader.readAsText(file);
    }
    
    // 文本换行函数
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
      const lines = text.split('\n');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        context.fillText(line, x, y);
        y += lineHeight;
      }
    }
  </script>
</body>
</html>