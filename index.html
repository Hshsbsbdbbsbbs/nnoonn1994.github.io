<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高级文本编辑器</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --editor-bg: #fff;
            --toolbar-bg: #ecf0f1;
            --border-color: #bdc3c7;
            --highlight-bg: #fffacd;
            --autocomplete-bg: #fff;
            --autocomplete-border: #ccc;
            --autocomplete-hover: #f0f0f0;
        }

        .dark-theme {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --editor-bg: #1e2a36;
            --toolbar-bg: #2c3e50;
            --border-color: #7f8c8d;
            --highlight-bg: #3d4c5e;
            --autocomplete-bg: #2c3e50;
            --autocomplete-border: #7f8c8d;
            --autocomplete-hover: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--toolbar-bg);
            border-radius: 5px;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        button {
            padding: 6px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.85rem;
            -webkit-user-select: none;
            user-select: none;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        select, input {
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--editor-bg);
            color: var(--text-color);
            font-size: 0.85rem;
            -webkit-user-select: text;
            user-select: text;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Safari兼容性修复 */
        input[type="text"] {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        .search-box {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .editor-wrapper {
            flex: 1;
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            background-color: var(--editor-bg);
            position: relative;
        }

        #editor {
            flex: 1;
            padding: 10px;
            border: none;
            resize: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: var(--editor-bg);
            color: var(--text-color);
            outline: none;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
            -webkit-user-select: text;
            user-select: text;
            -webkit-overflow-scrolling: touch;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background-color: var(--toolbar-bg);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .highlight {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            padding: 2px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--editor-bg);
            padding: 15px;
            border-radius: 5px;
            width: 350px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-body {
            margin-bottom: 10px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .close {
            cursor: pointer;
            font-size: 1.2rem;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        /* 语法高亮样式 */
        .keyword { color: #d73a49; font-weight: bold; }
        .string { color: #032f62; font-family: 'Consolas', monospace; }
        .number { color: #005cc5; font-weight: bold; }
        .comment { color: #6a737d; font-style: italic; font-family: 'Consolas', monospace; }
        .function { color: #6f42c1; font-weight: bold; }
        .operator { color: #d73a49; font-weight: bold; }
        .punctuation { color: #24292e; }
        .property { color: #22863a; font-weight: bold; }
        .boolean { color: #005cc5; font-weight: bold; }
        .null { color: #005cc5; font-weight: bold; }
        .variable { color: #e36209; font-family: 'Consolas', monospace; }

        .dark-theme .keyword { color: #ff7b72; font-weight: bold; }
        .dark-theme .string { color: #a5d6ff; font-family: 'Consolas', monospace; }
        .dark-theme .number { color: #79c0ff; font-weight: bold; }
        .dark-theme .comment { color: #8b949e; font-style: italic; font-family: 'Consolas', monospace; }
        .dark-theme .function { color: #d2a8ff; font-weight: bold; }
        .dark-theme .operator { color: #ff7b72; font-weight: bold; }
        .dark-theme .punctuation { color: #c9d1d9; }
        .dark-theme .property { color: #7ee787; font-weight: bold; }
        .dark-theme .boolean { color: #79c0ff; font-weight: bold; }
        .dark-theme .null { color: #79c0ff; font-weight: bold; }
        .dark-theme .variable { color: #ffab70; font-family: 'Consolas', monospace; }

        /* 自动补全样式 */
        .autocomplete-list {
            position: absolute;
            background-color: var(--autocomplete-bg);
            border: 1px solid var(--autocomplete-border);
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        .autocomplete-item:hover {
            background-color: var(--autocomplete-hover);
        }

        .autocomplete-item.selected {
            background-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }
            
            .toolbar-group {
                justify-content: center;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>高级文本编辑器</h1>
            <button id="themeToggle" class="theme-toggle">切换主题</button>
        </header>

        <div class="toolbar">
            <div class="toolbar-group">
                <button id="newFile">新建</button>
                <button id="openFile">打开文件</button>
                <button id="saveFile">保存到本地</button>
                <button id="copyAll">复制全部</button>
            </div>
            <div class="toolbar-group">
                <button id="undoBtn" disabled>撤销</button>
                <button id="redoBtn" disabled>重做</button>
            </div>
            <div class="toolbar-group">
                <button id="findBtn">查找</button>
                <button id="replaceBtn">替换</button>
            </div>
        </div>

        <div class="editor-wrapper">
            <div id="editor" contenteditable="true"></div>
        </div>

        <div class="status-bar">
            <span id="charCount">字符数: 0</span>
            <span id="lineCount">行数: 1</span>
            <span id="fileTypeDisplay">文件格式: TXT</span>
            <span id="cursorPosition">行: 1, 列: 1</span>
        </div>
    </div>

    <!-- 查找模态框 -->
    <div id="findModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>查找</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="findInput" placeholder="输入要查找的内容">
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="matchCase">
                    <label for="matchCase">区分大小写</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="findPrev">上一个</button>
                <button id="findNext">下一个</button>
                <button id="closeFind">关闭</button>
            </div>
        </div>
    </div>

    <!-- 替换模态框 -->
    <div id="replaceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>查找和替换</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 10px;">
                    <input type="text" id="replaceFindInput" placeholder="查找内容">
                </div>
                <div>
                    <input type="text" id="replaceInput" placeholder="替换为">
                </div>
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="replaceMatchCase">
                    <label for="replaceMatchCase">区分大小写</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="replaceBtnModal">替换</button>
                <button id="replaceAllBtn">全部替换</button>
                <button id="closeReplace">关闭</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const editor = document.getElementById('editor');
            const themeToggle = document.getElementById('themeToggle');
            const newFileBtn = document.getElementById('newFile');
            const openFileBtn = document.getElementById('openFile');
            const saveFileBtn = document.getElementById('saveFile');
            const copyAllBtn = document.getElementById('copyAll');
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const findBtn = document.getElementById('findBtn');
            const replaceBtn = document.getElementById('replaceBtn');
            const charCount = document.getElementById('charCount');
            const lineCount = document.getElementById('lineCount');
            const fileTypeDisplay = document.getElementById('fileTypeDisplay');
            const cursorPosition = document.getElementById('cursorPosition');
            
            // 模态框相关元素
            const findModal = document.getElementById('findModal');
            const replaceModal = document.getElementById('replaceModal');
            const findInput = document.getElementById('findInput');
            const replaceFindInput = document.getElementById('replaceFindInput');
            const replaceInput = document.getElementById('replaceInput');
            const findPrevBtn = document.getElementById('findPrev');
            const findNextBtn = document.getElementById('findNext');
            const closeFindBtn = document.getElementById('closeFind');
            const replaceBtnModal = document.getElementById('replaceBtnModal');
            const replaceAllBtn = document.getElementById('replaceAllBtn');
            const closeReplaceBtn = document.getElementById('closeReplace');
            const closeButtons = document.querySelectorAll('.close');
            
            // 状态变量
            let isDarkTheme = false;
            let history = [];
            let historyIndex = -1;
            let currentFindIndex = -1;
            let findResults = [];
            let autocompleteList = null;
            let autocompleteItems = [];
            let autocompleteIndex = -1;
            let currentFileName = 'untitled';
            let isFinding = false; // 新增：标记是否正在查找
            
            // Safari兼容性修复 - 确保输入框可点击
            function fixSafariInputIssues() {
                // 为所有输入框添加touch事件处理
                const inputs = document.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    // 防止双击缩放
                    input.addEventListener('touchstart', function(e) {
                        if (e.touches.length > 1) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                    
                    // 确保输入框可以获得焦点
                    input.addEventListener('touchend', function(e) {
                        this.focus();
                        e.preventDefault();
                    }, { passive: false });
                    
                    // 修复Safari中输入框的点击问题
                    input.addEventListener('click', function(e) {
                        this.focus();
                    });
                });
            }
            
            // 防止页面缩放
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });
            
            // 初始化编辑器
            function initEditor() {
                updateStatus();
                applySyntaxHighlighting();
                fixSafariInputIssues(); // 修复Safari输入问题
                
                // 监听输入事件
                editor.addEventListener('input', function() {
                    updateStatus();
                    if (!isFinding) {
                        applySyntaxHighlighting();
                    }
                    addToHistory();
                    
                    // 显示自动补全
                    showAutocomplete();
                });
                
                // 监听键盘事件
                editor.addEventListener('keydown', function(e) {
                    // Tab键处理
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        insertTextAtCursor('    ');
                    }
                    
                    // 自动补全导航
                    if (autocompleteList && autocompleteList.style.display !== 'none') {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            navigateAutocomplete(1);
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            navigateAutocomplete(-1);
                        } else if (e.key === 'Enter' || e.key === 'Tab') {
                            e.preventDefault();
                            selectAutocompleteItem();
                        } else if (e.key === 'Escape') {
                            hideAutocomplete();
                        }
                    }
                });
                
                // 监听光标位置变化
                editor.addEventListener('click', updateCursorPosition);
                editor.addEventListener('keyup', updateCursorPosition);
                editor.addEventListener('mouseup', updateCursorPosition);
                
                // 监听选择变化事件（用于撤销/重做按钮状态）
                document.addEventListener('selectionchange', function() {
                    updateUndoRedoButtons();
                });
                
                // 初始化历史记录
                addToHistory();
            }
            
            // 更新状态栏
            function updateStatus() {
                const text = editor.innerText;
                const charCountValue = text.length;
                const lineCountValue = text.split('\n').length;
                
                charCount.textContent = `字符数: ${charCountValue}`;
                lineCount.textContent = `行数: ${lineCountValue}`;
                fileTypeDisplay.textContent = `文件格式: TXT`;
            }
            
            // 更新光标位置
            function updateCursorPosition() {
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return;
                
                const range = selection.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(editor);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                
                const text = preCaretRange.toString();
                const lines = text.split('\n');
                const line = lines.length;
                const column = lines[lines.length - 1].length + 1;
                
                cursorPosition.textContent = `行: ${line}, 列: ${column}`;
            }
            
            // 语法高亮
            function applySyntaxHighlighting() {
                if (isFinding) return; // 如果正在查找，不应用语法高亮
                
                const text = editor.innerText;
                const highlightedText = highlightPlainText(text);
                
                // 保存当前光标位置
                const selection = window.getSelection();
                const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                
                // 应用高亮后的HTML
                editor.innerHTML = highlightedText;
                
                // 恢复光标位置
                if (range) {
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            // 纯文本基本高亮
            function highlightPlainText(text) {
                // 对纯文本应用一些基本的高亮规则
                return text
                    .replace(/(\b(function|if|else|for|while|return|var|let|const)\b)/g, '<span class="keyword">$1</span>')
                    .replace(/("[^"]*"|'[^']*')/g, '<span class="string">$1</span>')
                    .replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>')
                    .replace(/(\/\/.*$)/gm, '<span class="comment">$1</span>');
            }
            
            // 历史记录功能
            function addToHistory() {
                // 如果我们在历史记录中间，删除之后的所有记录
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                
                // 添加新状态到历史记录
                history.push(editor.innerHTML);
                historyIndex++;
                
                // 限制历史记录长度
                if (history.length > 50) {
                    history.shift();
                    historyIndex--;
                }
                
                updateUndoRedoButtons();
            }
            
            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    editor.innerHTML = history[historyIndex];
                    updateStatus();
                }
                updateUndoRedoButtons();
            }
            
            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    editor.innerHTML = history[historyIndex];
                    updateStatus();
                }
                updateUndoRedoButtons();
            }
            
            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= history.length - 1;
            }
            
            // 文件操作
            function newFile() {
                if (editor.innerText && !confirm('确定要创建新文件吗？未保存的内容将会丢失。')) {
                    return;
                }
                editor.innerText = '';
                history = [''];
                historyIndex = 0;
                currentFileName = 'untitled';
                updateStatus();
                applySyntaxHighlighting();
            }
            
            function openFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*.*';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        editor.innerText = content;
                        currentFileName = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
                        
                        updateStatus();
                        applySyntaxHighlighting();
                        addToHistory();
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            // 保存文件到本地
            function saveFileToLocal() {
                const content = editor.innerText;
                const mimeType = 'text/plain';
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentFileName}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`文件已保存为 ${currentFileName}.txt`);
            }
            
            // 复制全部文本
            function copyAllText() {
                const text = editor.innerText;
                navigator.clipboard.writeText(text).then(function() {
                    alert('文本已复制到剪贴板');
                }, function(err) {
                    console.error('复制失败: ', err);
                    // 降级方案
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('文本已复制到剪贴板');
                });
            }
            
            // 查找功能
            function openFindModal() {
                findModal.style.display = 'flex';
                findInput.focus();
                findInput.select();
            }
            
            function closeFindModal() {
                findModal.style.display = 'none';
                clearHighlights();
            }
            
            function findText(direction = 'next') {
                const searchText = findInput.value;
                if (!searchText) return;
                
                const matchCase = document.getElementById('matchCase').checked;
                const flags = matchCase ? 'g' : 'gi';
                const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
                
                // 清除之前的高亮
                clearHighlights();
                
                // 查找所有匹配项
                const text = editor.innerText;
                findResults = [];
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    findResults.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        text: match[0]
                    });
                }
                
                if (findResults.length === 0) {
                    alert('未找到匹配项');
                    return;
                }
                
                // 根据方向更新当前索引
                if (direction === 'next') {
                    currentFindIndex = (currentFindIndex + 1) % findResults.length;
                } else {
                    currentFindIndex = (currentFindIndex - 1 + findResults.length) % findResults.length;
                }
                
                // 高亮当前匹配项
                highlightCurrentFind();
                
                // 滚动到匹配项
                scrollToFind();
            }
            
            function highlightCurrentFind() {
                if (currentFindIndex < 0 || currentFindIndex >= findResults.length) return;
                
                isFinding = true; // 标记正在查找
                
                const result = findResults[currentFindIndex];
                const text = editor.innerText;
                
                // 创建高亮文本
                const before = text.substring(0, result.start);
                const match = text.substring(result.start, result.end);
                const after = text.substring(result.end);
                
                editor.innerHTML = before + '<span class="highlight">' + match + '</span>' + after;
                
                // 更新状态显示
                const modalFooter = document.querySelector('#findModal .modal-footer');
                // 清除之前的状态显示
                const statusSpan = modalFooter.querySelector('.find-status');
                if (statusSpan) {
                    statusSpan.remove();
                }
                // 添加新的状态显示
                modalFooter.innerHTML += `<span class="find-status" style="margin-left: 10px;">${currentFindIndex + 1}/${findResults.length}</span>`;
            }
            
            function clearHighlights() {
                isFinding = false; // 标记查找结束
                applySyntaxHighlighting();
                currentFindIndex = -1;
                findResults = [];
            }
            
            function scrollToFind() {
                if (currentFindIndex < 0) return;
                
                const highlight = editor.querySelector('.highlight');
                if (highlight) {
                    highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 选中高亮文本
                    const range = document.createRange();
                    range.selectNodeContents(highlight);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            // 替换功能
            function openReplaceModal() {
                replaceModal.style.display = 'flex';
                replaceFindInput.focus();
                replaceFindInput.select();
            }
            
            function closeReplaceModal() {
                replaceModal.style.display = 'none';
                clearHighlights();
            }
            
            function replaceText() {
                const findText = replaceFindInput.value;
                const replaceText = replaceInput.value;
                
                if (!findText) return;
                
                const matchCase = document.getElementById('replaceMatchCase').checked;
                const flags = matchCase ? 'g' : 'gi';
                const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
                
                // 如果有高亮的查找结果，只替换当前高亮项
                if (currentFindIndex >= 0 && findResults.length > 0) {
                    const result = findResults[currentFindIndex];
                    const text = editor.innerText;
                    const before = text.substring(0, result.start);
                    const after = text.substring(result.end);
                    
                    editor.innerText = before + replaceText + after;
                    applySyntaxHighlighting();
                    
                    // 更新查找结果
                    findText('next');
                } else {
                    // 否则替换第一个匹配项
                    const text = editor.innerText;
                    const newText = text.replace(regex, replaceText);
                    
                    if (newText !== text) {
                        editor.innerText = newText;
                        applySyntaxHighlighting();
                        addToHistory();
                        alert('已替换第一个匹配项');
                    } else {
                        alert('未找到匹配项');
                    }
                }
            }
            
            function replaceAllText() {
                const findText = replaceFindInput.value;
                const replaceText = replaceInput.value;
                
                if (!findText) return;
                
                const matchCase = document.getElementById('replaceMatchCase').checked;
                const flags = matchCase ? 'g' : 'gi';
                const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
                
                const text = editor.innerText;
                const newText = text.replace(regex, replaceText);
                
                if (newText !== text) {
                    editor.innerText = newText;
                    applySyntaxHighlighting();
                    addToHistory();
                    alert(`已替换所有匹配项，共 ${(text.match(regex) || []).length} 处`);
                } else {
                    alert('未找到匹配项');
                }
            }
            
            // 自动补全功能
            function showAutocomplete() {
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return;
                
                const range = selection.getRangeAt(0);
                const textBeforeCursor = editor.innerText.substring(0, range.startOffset);
                const words = textBeforeCursor.split(/\s+/);
                const currentWord = words[words.length - 1];
                
                // 如果当前单词为空或太短，不显示自动补全
                if (!currentWord || currentWord.length < 2) {
                    hideAutocomplete();
                    return;
                }
                
                // 获取建议列表
                const suggestions = getAutocompleteSuggestions(currentWord);
                
                if (suggestions.length === 0) {
                    hideAutocomplete();
                    return;
                }
                
                // 创建或更新自动补全列表
                if (!autocompleteList) {
                    autocompleteList = document.createElement('div');
                    autocompleteList.className = 'autocomplete-list';
                    document.body.appendChild(autocompleteList);
                }
                
                // 清空之前的项目
                autocompleteList.innerHTML = '';
                autocompleteItems = [];
                
                // 添加建议项目
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = suggestion;
                    item.addEventListener('click', function() {
                        selectAutocompleteItem(suggestion);
                    });
                    autocompleteList.appendChild(item);
                    autocompleteItems.push(item);
                });
                
                // 定位自动补全列表
                const rect = range.getBoundingClientRect();
                autocompleteList.style.left = rect.left + 'px';
                autocompleteList.style.top = (rect.bottom + window.scrollY) + 'px';
                autocompleteList.style.display = 'block';
                
                // 重置选中索引
                autocompleteIndex = -1;
            }
            
            function hideAutocomplete() {
                if (autocompleteList) {
                    autocompleteList.style.display = 'none';
                }
            }
            
            function navigateAutocomplete(direction) {
                if (autocompleteItems.length === 0) return;
                
                // 移除之前选中的项目
                if (autocompleteIndex >= 0) {
                    autocompleteItems[autocompleteIndex].classList.remove('selected');
                }
                
                // 更新索引
                autocompleteIndex += direction;
                if (autocompleteIndex < 0) {
                    autocompleteIndex = autocompleteItems.length - 1;
                } else if (autocompleteIndex >= autocompleteItems.length) {
                    autocompleteIndex = 0;
                }
                
                // 选中新项目
                autocompleteItems[autocompleteIndex].classList.add('selected');
                
                // 确保选中的项目在视图中
                autocompleteItems[autocompleteIndex].scrollIntoView({
                    block: 'nearest'
                });
            }
            
            function selectAutocompleteItem(suggestion) {
                if (!autocompleteList || autocompleteItems.length === 0) return;
                
                const selectedSuggestion = suggestion || 
                    (autocompleteIndex >= 0 ? autocompleteItems[autocompleteIndex].textContent : null);
                
                if (!selectedSuggestion) return;
                
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return;
                
                const range = selection.getRangeAt(0);
                const textBeforeCursor = editor.innerText.substring(0, range.startOffset);
                const words = textBeforeCursor.split(/\s+/);
                const currentWord = words[words.length - 1];
                
                // 计算要替换的文本长度
                const replaceLength = currentWord.length;
                
                // 删除当前单词
                range.setStart(range.startContainer, range.startOffset - replaceLength);
                range.deleteContents();
                
                // 插入选中的建议
                range.insertNode(document.createTextNode(selectedSuggestion));
                
                // 隐藏自动补全
                hideAutocomplete();
                
                // 更新编辑器
                applySyntaxHighlighting();
                addToHistory();
            }
            
            function getAutocompleteSuggestions(currentWord) {
                let suggestions = [
                    'function', 'if', 'else', 'for', 'while', 'return',
                    'var', 'let', 'const', 'class', 'import', 'export',
                    'console', 'log', 'window', 'document', 'this',
                    'true', 'false', 'null'
                ];
                
                // 过滤与当前单词匹配的建议
                return suggestions.filter(suggestion => 
                    suggestion.toLowerCase().startsWith(currentWord.toLowerCase())
                );
            }
            
            // 在光标位置插入文本
            function insertTextAtCursor(text) {
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return;
                
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                
                // 移动光标到插入文本之后
                range.setStart(range.endContainer, range.endOffset);
                range.setEnd(range.endContainer, range.endOffset);
                selection.removeAllRanges();
                selection.addRange(range);
                
                applySyntaxHighlighting();
                addToHistory();
            }
            
            // 主题切换
            function toggleTheme() {
                isDarkTheme = !isDarkTheme;
                document.body.classList.toggle('dark-theme', isDarkTheme);
                themeToggle.textContent = isDarkTheme ? '浅色主题' : '深色主题';
                applySyntaxHighlighting();
            }
            
            // 事件监听器
            themeToggle.addEventListener('click', toggleTheme);
            newFileBtn.addEventListener('click', newFile);
            openFileBtn.addEventListener('click', openFile);
            saveFileBtn.addEventListener('click', saveFileToLocal);
            copyAllBtn.addEventListener('click', copyAllText);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            findBtn.addEventListener('click', openFindModal);
            replaceBtn.addEventListener('click', openReplaceModal);
            
            // 查找模态框事件
            findNextBtn.addEventListener('click', () => findText('next'));
            findPrevBtn.addEventListener('click', () => findText('prev'));
            closeFindBtn.addEventListener('click', closeFindModal);
            
            // 替换模态框事件
            replaceBtnModal.addEventListener('click', replaceText);
            replaceAllBtn.addEventListener('click', replaceAllText);
            closeReplaceBtn.addEventListener('click', closeReplaceModal);
            
            // 关闭模态框
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                    clearHighlights();
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === findModal) {
                    closeFindModal();
                }
                if (e.target === replaceModal) {
                    closeReplaceModal();
                }
                // 点击自动补全外部时隐藏
                if (autocompleteList && e.target !== autocompleteList && 
                    !autocompleteList.contains(e.target)) {
                    hideAutocomplete();
                }
            });
            
            // 初始化编辑器
            initEditor();
        });
    </script>
</body>
</html>