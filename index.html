<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TVBOX加密解密工具</title>
  <style>
    :root {
      --primary-color: #409EFF;
      --success-color: #67C23A;
      --warning-color: #E6A23C;
      --danger-color: #F56C6C;
      --text-color: #303133;
      --border-color: #DCDFE6;
      --bg-color: #F5F7FA;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .header {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color), #3375b9);
      color: white;
      text-align: center;
    }
    .header h1 {
      font-size: 24px;
      font-weight: 500;
    }
    .content {
      display: flex;
      padding: 20px;
      gap: 20px;
    }
    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .panel-title {
      font-size: 16px;
      font-weight: 500;
    }
    .textarea-container {
      flex: 1;
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }
    textarea {
      width: 100%;
      height: 100%;
      padding: 12px;
      border: none;
      resize: none;
      font-family: monospace;
      font-size: 14px;
      outline: none;
    }
    .control-panel {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    label {
      font-size: 14px;
      font-weight: 500;
    }
    input[type="text"] {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-primary:hover {
      background-color: #66b1ff;
    }
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    .btn-success:hover {
      background-color: #85ce61;
    }
    .btn-group {
      display: flex;
      gap: 10px;
    }
    .btn-block {
      width: 100%;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      display: none;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .file-input {
      display: none;
    }
    .divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 15px 0;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }
    .status-success {
      background-color: #f0f9eb;
      color: var(--success-color);
    }
    .status-error {
      background-color: #fef0f0;
      color: var(--danger-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TVBOX加密解密工具</h1>
    </div>
    <div class="content">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">输入内容</span>
        </div>
        <div class="textarea-container">
          <textarea id="inputText" placeholder="请输入要加密/解密的文本内容..."></textarea>
        </div>
      </div>
      
      <div class="control-panel">
        <div class="form-group">
          <label for="operation">操作类型</label>
          <select id="operation" class="btn btn-block">
            <option value="encrypt">加密</option>
            <option value="decrypt">解密</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="key">加密密钥 (KEY)</label>
          <input type="text" id="key" value="123456" maxlength="16" placeholder="16位字符">
        </div>
        
        <div class="form-group">
          <label for="iv">初始向量 (IV)</label>
          <input type="text" id="iv" placeholder="自动生成" maxlength="13">
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="base64Check">
          <label for="base64Check">Base64解码</label>
        </div>
        
        <div class="btn-group">
          <button id="uploadBtn" class="btn btn-primary">
            <span>上传文件</span>
          </button>
          <input type="file" id="fileInput" class="file-input">
        </div>
        
        <div class="btn-group">
          <button id="processBtn" class="btn btn-success btn-block">
            <span>执行操作</span>
          </button>
        </div>
        
        <div class="divider"></div>
        
        <div class="btn-group">
          <button id="toImgBtn" class="btn btn-primary">
            <span>生成加密图片</span>
          </button>
          <input type="file" id="bgImageInput" accept="image/*" class="file-input">
        </div>
        
        <div class="btn-group">
          <button id="fromImgBtn" class="btn btn-success">
            <span>从图片解密</span>
          </button>
          <input type="file" id="imgInput" accept="image/*" class="file-input">
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <img id="imagePreview" class="image-preview" alt="图片预览">
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">输出结果</span>
          <button id="copyBtn" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">
            <span>复制</span>
          </button>
        </div>
        <div class="textarea-container">
          <textarea id="outputText" placeholder="处理结果将显示在这里..." readonly></textarea>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化IV为当前时间戳
      document.getElementById('iv').value = new Date().getTime();
      
      let bgImageData = null;
      
      // 上传文件
      document.getElementById('uploadBtn').addEventListener('click', function() {
        document.getElementById('fileInput').click();
      });
      
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('inputText').value = e.target.result;
          showStatus('文件加载成功', 'success');
        };
        reader.readAsText(file);
      });
      
      // 上传背景图片
      document.getElementById('toImgBtn').addEventListener('click', function() {
        document.getElementById('bgImageInput').click();
      });
      
      document.getElementById('bgImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          bgImageData = e.target.result;
          const imgPreview = document.getElementById('imagePreview');
          imgPreview.src = bgImageData;
          imgPreview.style.display = 'block';
          showStatus('背景图片已加载', 'success');
          
          // 自动生成加密图片
          generateSteganoImage(document.getElementById('inputText').value.trim());
        };
        reader.readAsDataURL(file);
      });
      
      // 从图片解密
      document.getElementById('fromImgBtn').addEventListener('click', function() {
        document.getElementById('imgInput').click();
      });
      
      document.getElementById('imgInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        readSteganoFromImage(file);
      });
      
      // 执行加密/解密操作
      document.getElementById('processBtn').addEventListener('click', processData);
      
      // 复制结果
      document.getElementById('copyBtn').addEventListener('click', function() {
        const outputText = document.getElementById('outputText');
        outputText.select();
        document.execCommand('copy');
        showStatus('已复制到剪贴板', 'success');
      });
      
      // 显示状态信息
      function showStatus(message, type) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.textContent = message;
        statusElement.className = `status-message status-${type}`;
        statusElement.style.display = 'block';
        
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 3000);
      }
      
      // AES加密函数
      function padTo16Byte(str) {
        return CryptoJS.enc.Utf8.parse(str.toString().padEnd(16, '0'));
      }
      
      function Encrypt(word, keyStr, ivStr) {
        const key = padTo16Byte(keyStr);
        const iv = padTo16Byte(ivStr);
        const encrypted = CryptoJS.AES.encrypt(word, key, { iv });
        return encrypted.ciphertext.toString(CryptoJS.enc.Hex);
      }
      
      function Decrypt(word, keyStr, ivStr) {
        const key = padTo16Byte(keyStr);
        const iv = padTo16Byte(ivStr);
        const ciphertext = CryptoJS.enc.Hex.parse(word);
        const decrypt = CryptoJS.AES.decrypt({ ciphertext }, key, { iv });
        return decrypt.toString(CryptoJS.enc.Utf8);
      }
      
      function decryptAesBCB(encryptedData) {
        var dataArr = encryptedData.split("");
        var prefixCode = CryptoJS.enc.Utf8.parse("$#").toString();
        var suffixCode = CryptoJS.enc.Utf8.parse("#$").toString();
        var pwdMix = dataArr
          .splice(0, encryptedData.indexOf(suffixCode) + 4)
          .join("");
        var roundtimeInHax = dataArr.splice(dataArr.length - 26, 26).join("");
        var encryptedText = dataArr.join("");
        var pwdInHax = pwdMix.substring(
          prefixCode.length,
          pwdMix.length - suffixCode.length
        );
        var roundTime = CryptoJS.enc.Utf8.stringify(
          CryptoJS.enc.Hex.parse(roundtimeInHax)
        );
        var pwd = CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Hex.parse(pwdInHax));
        var iv = CryptoJS.enc.Utf8.parse(roundTime.padEnd(16, "0"));
        var pkBlocks = CryptoJS.enc.Utf8.parse(pwd.padEnd(16, "0"));
        var cipherParams = CryptoJS.lib.CipherParams.create({
          ciphertext: CryptoJS.enc.Hex.parse(encryptedText),
        });
        var decryptedData = CryptoJS.enc.Utf8.stringify(
          CryptoJS.AES.decrypt(cipherParams, pkBlocks, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7,
          })
        );
        return decryptedData;
      }
      
      function convertToHex(value) {
        return CryptoJS.enc.Hex.stringify(CryptoJS.enc.Utf8.parse(value));
      }
      
      // 处理数据
      function processData() {
        const inputText = document.getElementById('inputText').value.trim();
        const operation = document.getElementById('operation').value;
        const key = document.getElementById('key').value;
        const iv = document.getElementById('iv').value;
        const base64Check = document.getElementById('base64Check').checked;
        
        if (!inputText) {
          showStatus('请输入要处理的文本', 'error');
          return;
        }
        
        try {
          let result;
          
          if (operation === 'encrypt') {
            const resultData = Encrypt(inputText, key, iv);
            const keyHex = convertToHex(`$#${key}#$`);
            const ivHex = convertToHex(iv);
            result = `${keyHex}${resultData}${ivHex}`;
            showStatus('加密成功', 'success');
          } else {
            let encryptedData = inputText;
            if (base64Check) {
              encryptedData = window.atob(encryptedData.split("**")[1] || encryptedData);
            }
            result = decryptAesBCB(encryptedData);
            showStatus('解密成功', 'success');
          }
          
          document.getElementById('outputText').value = result;
        } catch (err) {
          console.error(err);
          showStatus('处理失败: ' + err.message, 'error');
        }
      }
      
      // 生成隐形水印图片
      function generateSteganoImage(text) {
        if (!text) {
          showStatus('请输入要隐藏的文本', 'error');
          return;
        }
        
        if (!bgImageData) {
          showStatus('请先上传背景图片', 'error');
          return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          // 加密文本
          const encryptedText = Encrypt(text, document.getElementById('key').value, document.getElementById('iv').value);
          
          // 简单的水印算法：修改LSB（最低有效位）
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          const textBits = stringToBits(encryptedText);
          let bitIndex = 0;
          
          for (let i = 0; i < data.length; i += 4) {
            if (bitIndex < textBits.length) {
              // 只修改RGB通道，不修改Alpha通道
              for (let j = 0; j < 3; j++) {
                if (bitIndex < textBits.length) {
                  // 清除最低位，然后设置为我们想要的位
                  data[i + j] = (data[i + j] & 0xFE) | parseInt(textBits[bitIndex]);
                  bitIndex++;
                }
              }
            } else {
              break;
            }
          }
          
          ctx.putImageData(imageData, 0, 0);
          finalizeImage(canvas);
          showStatus('加密图片生成成功', 'success');
        };
        img.src = bgImageData;
      }
      
      // 从图片读取隐形水印
      function readSteganoFromImage(file) {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = function(e) {
          img.src = e.target.result;
          
          img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const bits = [];
            
            // 提取LSB
            for (let i = 0; i < data.length; i += 4) {
              for (let j = 0; j < 3; j++) {
                bits.push(data[i + j] & 1);
              }
            }
            
            const encryptedText = bitsToString(bits);
            
            // 尝试解密
            try {
              const key = document.getElementById('key').value;
              const iv = document.getElementById('iv').value;
              const decryptedText = Decrypt(encryptedText, key, iv);
              
              document.getElementById('inputText').value = encryptedText;
              document.getElementById('outputText').value = decryptedText;
              showStatus('从图片解密成功', 'success');
            } catch (err) {
              document.getElementById('inputText').value = "无法解密，请检查密钥是否正确";
              showStatus('解密失败: ' + err.message, 'error');
            }
          };
        };
        
        reader.readAsDataURL(file);
      }
      
      // 最终处理生成的图片
      function finalizeImage(canvas) {
        const dataUrl = canvas.toDataURL('image/png');
        const imgPreview = document.getElementById('imagePreview');
        imgPreview.src = dataUrl;
        imgPreview.style.display = 'block';
        
        // 提供下载
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'tvbox_encrypted.png';
        link.click();
      }
      
      // 工具函数：字符串转二进制位
      function stringToBits(str) {
        const bits = [];
        for (let i = 0; i < str.length; i++) {
          const charCode = str.charCodeAt(i);
          for (let j = 7; j >= 0; j--) {
            bits.push((charCode >> j) & 1);
          }
        }
        // 添加结束标记
        bits.push(0, 0, 0, 0, 0, 0, 0, 0);
        return bits;
      }
      
      // 工具函数：二进制位转字符串
      function bitsToString(bits) {
        let str = '';
        for (let i = 0; i < bits.length; i += 8) {
          if (i + 8 > bits.length) break;
          
          let charCode = 0;
          for (let j = 0; j < 8; j++) {
            charCode = (charCode << 1) | bits[i + j];
          }
          
          if (charCode === 0) break; // 结束标记
          str += String.fromCharCode(charCode);
        }
        return str;
      }
    });
  </script>
</body>
</html>